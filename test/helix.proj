<Project DefaultTargets="Test">

  <!-- Version included until we get global.json generation to support this SDK. -->
  <Sdk Name="Microsoft.DotNet.Helix.Sdk" Version="1.0.0-beta.19057.4" />

  <Target Name="Gather" BeforeTargets="Test">
    <!-- <ReadLinesFromFile File="$(MSBuildThisFileDirectory)csprojs">
      <Output TaskParameter="Lines" ItemName="ProjectsToTest"/>  
    </ReadLinesFromFile> -->

    <ItemGroup>
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Antiforgery\test\Microsoft.AspNetCore.Antiforgery.Test.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\Abstractions\test\Microsoft.AspNetCore.DataProtection.Abstractions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\AzureKeyVault\test\Microsoft.AspNetCore.DataProtection.AzureKeyVault.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\AzureStorage\test\Microsoft.AspNetCore.DataProtection.AzureStorage.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\Cryptography.Internal\test\Microsoft.AspNetCore.Cryptography.Internal.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\Cryptography.KeyDerivation\test\Microsoft.AspNetCore.Cryptography.KeyDerivation.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\DataProtection\test\Microsoft.AspNetCore.DataProtection.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\Extensions\test\Microsoft.AspNetCore.DataProtection.Extensions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DataProtection\StackExchangeRedis\test\Microsoft.AspNetCore.DataProtection.StackExchangeRedis.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Features\JsonPatch\test\Microsoft.AspNetCore.JsonPatch.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Hosting\Hosting\test\Microsoft.AspNetCore.Hosting.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Hosting\test\FunctionalTests\Microsoft.AspNetCore.Hosting.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Hosting\TestHost\test\Microsoft.AspNetCore.TestHost.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Hosting\WindowsServices\test\Microsoft.AspNetCore.Hosting.WindowsServices.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Html\Abstractions\test\Microsoft.AspNetCore.Html.Abstractions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Headers\test\Microsoft.Net.Http.Headers.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Http\test\Microsoft.AspNetCore.Http.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Http.Abstractions\test\Microsoft.AspNetCore.Http.Abstractions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Http.Extensions\test\Microsoft.AspNetCore.Http.Extensions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Http.Features\test\Microsoft.AspNetCore.Http.Features.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Owin\test\Microsoft.AspNetCore.Owin.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Routing\test\FunctionalTests\Microsoft.AspNetCore.Routing.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Routing\test\UnitTests\Microsoft.AspNetCore.Routing.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\Routing.Abstractions\test\Microsoft.AspNetCore.Mvc.Routing.Abstractions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Http\WebUtilities\test\Microsoft.AspNetCore.WebUtilities.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Identity\ApiAuthorization.IdentityServer\test\Microsoft.AspNetCore.ApiAuthorization.IdentityServer.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Identity\test\Identity.FunctionalTests\Microsoft.AspNetCore.Identity.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\CORS\test\FunctionalTests\FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Diagnostics\test\FunctionalTests\Diagnostics.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Diagnostics\test\UnitTests\Microsoft.AspNetCore.Diagnostics.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Diagnostics.EntityFrameworkCore\test\FunctionalTests\Diagnostics.EFCore.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Diagnostics.EntityFrameworkCore\test\UnitTests\Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\HealthChecks\test\UnitTests\Microsoft.AspNetCore.Diagnostics.HealthChecks.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\HealthChecks.EntityFrameworkCore\test\Microsoft.Extensions.Diagnostics.HealthChecks.EntityFrameworkCore.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\HostFiltering\test\Microsoft.AspNetCore.HostFiltering.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\HttpOverrides\test\Microsoft.AspNetCore.HttpOverrides.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\HttpsPolicy\test\Microsoft.AspNetCore.HttpsPolicy.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Localization\test\FunctionalTests\Microsoft.AspNetCore.Localization.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Localization\test\UnitTests\Microsoft.AspNetCore.Localization.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Localization.Routing\test\Microsoft.AspNetCore.Localization.Routing.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\MiddlewareAnalysis\test\Microsoft.AspNetCore.MiddlewareAnalysis.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\ResponseCaching\test\Microsoft.AspNetCore.ResponseCaching.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\ResponseCompression\test\Microsoft.AspNetCore.ResponseCompression.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Rewrite\test\Microsoft.AspNetCore.Rewrite.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\Session\test\Microsoft.AspNetCore.Session.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\StaticFiles\test\FunctionalTests\Microsoft.AspNetCore.StaticFiles.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\StaticFiles\test\UnitTests\Microsoft.AspNetCore.StaticFiles.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\WebSockets\test\ConformanceTests\Microsoft.AspNetCore.WebSockets.ConformanceTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Middleware\WebSockets\test\UnitTests\Microsoft.AspNetCore.WebSockets.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Mvc\test\Microsoft.AspNetCore.Mvc.IntegrationTests\Microsoft.AspNetCore.Mvc.IntegrationTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Shared\test\Shared.Tests\Microsoft.AspNetCore.Shared.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\clients\csharp\Client\test\FunctionalTests\Microsoft.AspNetCore.SignalR.Client.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\clients\csharp\Client\test\UnitTests\Microsoft.AspNetCore.SignalR.Client.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\common\Http.Connections\test\Microsoft.AspNetCore.Http.Connections.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\common\SignalR.Common\test\Microsoft.AspNetCore.SignalR.Common.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\server\SignalR\test\Microsoft.AspNetCore.SignalR.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\server\StackExchangeRedis\test\Microsoft.AspNetCore.SignalR.StackExchangeRedis.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Tools\dotnet-user-secrets\test\dotnet-user-secrets.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Tools\dotnet-watch\test\dotnet-watch.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Tools\FirstRunCertGenerator\test\Microsoft.AspNetCore.DeveloperCertificates.XPlat.Tests.csproj" />


    </ItemGroup>

    <!-- passing
    -->    
    
    <!-- skipped (build errors needs investigation)

      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\AuthSamples\test\AuthSamples.FunctionalTests\AuthSamples.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Azure\AzureAD\test\FunctionalTests\Microsoft.AspNetCore.Authentication.AzureAD.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Azure\AzureAppServicesIntegration\test\Microsoft.AspNetCore.AzureAppServicesIntegration.Tests.csproj" />

      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SiteExtensions\Microsoft.Web.Xdt.Extensions\tests\Microsoft.Web.Xdt.Extensions.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SiteExtensions\LoggingAggregate\test\Microsoft.AspNetCore.AzureAppServices.SiteExtension.Tests\Microsoft.AspNetCore.AzureAppServices.SiteExtension.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\SignalR\clients\ts\FunctionalTests\FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Mvc\test\Microsoft.AspNetCore.Mvc.FunctionalTests\Microsoft.AspNetCore.Mvc.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Framework\test\Microsoft.AspNetCore.App.UnitTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\Interop.FunctionalTests\Interop.FunctionalTests.csproj" />

      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\HttpSys\test\FunctionalTests\Microsoft.AspNetCore.Server.HttpSys.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\HttpSys\test\Tests\Microsoft.AspNetCore.Server.HttpSys.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\Common.Tests\Common.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\IIS.BackwardsCompatibility.FunctionalTests\IIS.BackwardsCompatibility.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\IIS.ForwardsCompatibility.FunctionalTests\IIS.ForwardsCompatibility.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\IIS.FunctionalTests\IIS.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\IIS.Tests\IIS.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IIS\test\IISExpress.FunctionalTests\IISExpress.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\IIS\IISIntegration\test\Tests\Microsoft.AspNetCore.Server.IISIntegration.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\Core\test\Microsoft.AspNetCore.Server.Kestrel.Core.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\Kestrel\test\Microsoft.AspNetCore.Server.Kestrel.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\InMemory.FunctionalTests\InMemory.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\Libuv.BindTests\Libuv.BindTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\Libuv.FunctionalTests\Libuv.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\Sockets.BindTests\Sockets.BindTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\test\Sockets.FunctionalTests\Sockets.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\Kestrel\Transport.Libuv\test\Microsoft.AspNetCore.Server.Kestrel.Transport.Libuv.Tests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\Servers\test\FunctionalTests\ServerComparison.FunctionalTests.csproj" />

      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\MusicStore\test\MusicStore.E2ETests\MusicStore.E2ETests.csproj" />

      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DefaultBuilder\test\Microsoft.AspNetCore.FunctionalTests\Microsoft.AspNetCore.FunctionalTests.csproj" />
      <ProjectsToTest Include="$(MSBuildThisFileDirectory)..\src\DefaultBuilder\test\Microsoft.AspNetCore.Tests\Microsoft.AspNetCore.Tests.csproj" />

    -->
    <MSBuild Projects="@(ProjectsToTest)"
              Targets="CreateHelixPayload"
              BuildInParallel="true">
      <Output TaskParameter="TargetOutputs" ItemName="HelixPayload" />
    </MSBuild>
    <ItemGroup>
      <HelixWorkItem Include="%(HelixPayload.TestName)">
        <Command>%(HelixPayload.Command)</Command>
        <PayloadDirectory>%(HelixPayload.Identity)</PayloadDirectory>
        <Timeout>%(HelixPayload.TestTimeout)</Timeout>
      </HelixWorkItem>
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <!-- TODO: Follow up with helix SDK -->
    <SkipInvalidConfigurations>true</SkipInvalidConfigurations>
    <HelixSource>pr/aspnet/aspnetcore</HelixSource>
    <HelixType>ci</HelixType>
    <HelixBuild>private-$(USERNAME)</HelixBuild>
    <HelixBuild Condition=" '$(CI)' == 'true' ">$(BUILD_BUILDNUMBER)</HelixBuild>
    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <IsExternal>true</IsExternal>
    <Creator>aspnetcore</Creator>

    <HelixTargetQueues>Windows.10.Amd64.Open;OSX.1012.Amd64.Open;Ubuntu.1604.Amd64.Open;Ubuntu.1810.Amd64.Open;Centos.7.Amd64.Open;Debian.8.Amd64.Open;Debian.9.Amd64.Open;Fedora.27.Amd64.Open;Fedora.28.Amd64.Open;Redhat.7.Amd64.Open;</HelixTargetQueues>
    
    <!--
      xml file found in the work item working directory.
      The following file names are accepted:
        testResults.xml
        test-results.xml
        test_results.xml
    -->
    <!-- <EnableXUnitReporter Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework'">false</EnableXUnitReporter> -->

  </PropertyGroup>
</Project> 
